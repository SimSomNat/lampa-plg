<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lampa Plugins – SimSomNat</title>
<style>
  :root{--bg:#0b1220;--card:#111a2a;--border:#1c2a44;--text:#e7eefc;--muted:#a8b4ce}
  *{box-sizing:border-box}
  body{font:16px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:920px;margin:40px auto;padding:0 16px;background:var(--bg);color:var(--text)}
  h1{font-size:28px;margin:0 0 8px}
  ul{list-style:none;padding:0;margin:20px 0}
  li.item{display:flex;align-items:center;justify-content:space-between;gap:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:12px 0}
  .left{min-width:0}
  .left strong{display:block;font-size:18px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .left small{color:var(--muted)}
  .right{flex:0 0 auto;display:flex;gap:8px}
  .btn{appearance:none;border:1px solid var(--border);background:#16233a;color:#cfe0ff;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;font-size:14px}
  .btn:hover{border-color:#2a3d66}
  .btn.copy:disabled{opacity:.6;cursor:default}
  @media (max-width:580px){ li.item{flex-direction:column;align-items:stretch} .right{justify-content:flex-start} }
</style>

<h1>Lampa Plugins</h1>
<ul id="list"><li class="item"><div class="left"><strong>Загружаю список…</strong><small>Ссылки на плагин для Lampa</small></div></li></ul>

<script>
const user='SimSomNat', repo='lampa-plg', branch='main';
const pagesBase=`https://${user.toLowerCase()}.github.io/${repo}/`;

/* тянем описание из начала .js файла:
   поддерживаем // @lampa-desc: ... и блок /* @lampa { "desc":"..." } *\/ */
async function getDesc(relPath){
  try{
    const res = await fetch(pagesBase + relPath + '?_=' + Date.now()); // анти-кэш
    const txt = await res.text();

    const mBlock = txt.match(/\/\*\s*@lampa([\s\S]*?)\*\//);
    if (mBlock){
      try{
        const j = JSON.parse(mBlock[1]);
        if (j.desc) return String(j.desc).trim();
      }catch(e){}
    }

    const mLine = txt.match(/^\s*\/\/\s*@lampa-desc\s*:\s*(.+)$/m);
    if (mLine) return mLine[1].trim();
  }catch(e){}
  return '';
}

async function walk(path=''){
  const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${branch}`);
  const items = await res.json();
  if (!Array.isArray(items)) throw new Error('GitHub API error/limit');
  for (const it of items){
    if (it.type === 'file' && it.name.endsWith('.js')) await add(it.path);
    if (it.type === 'dir') await walk(it.path);
  }
}

async function add(relPath){
  const url = pagesBase + relPath; // ЧИСТЫЙ URL без ?v
  const li = document.createElement('li');
  li.className = 'item';
  li.innerHTML = `
    <div class="left">
      <strong>${relPath}</strong>
      <small>Ссылки на плагин для Lampa</small>
    </div>
    <div class="right">
      <a class="btn" href="${url}" target="_blank" rel="noopener">Открыть плагин</a>
      <button class="btn copy" data-url="${url}" aria-label="Скопировать ссылку">Скопировать ссылку</button>
    </div>`;
  document.getElementById('list').appendChild(li);

  // заменить текст на @lampa-desc из файла плагина
  const desc = await getDesc(relPath);
  if (desc){
    const small = li.querySelector('.left small');
    if (small) small.textContent = desc;
  }
}

document.getElementById('list').addEventListener('click', async (e)=>{
  const btn = e.target.closest('.copy');
  if (!btn) return;
  const link = btn.dataset.url;
  try{
    await navigator.clipboard.writeText(link);
    const old = btn.textContent;
    btn.textContent = 'Скопировано!';
    btn.disabled = true;
    setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1400);
  }catch{
    prompt('Скопируйте ссылку:', link);
  }
});

walk().then(()=>{
  const first = document.querySelector('#list > li');
  if (first && first.querySelector('strong')?.textContent.includes('Загружаю')) first.remove();
}).catch(()=>{
  const ul = document.getElementById('list');
  ul.innerHTML = '';
  add('LocalBackup.js'); //fallback
});
</script>
</html>
