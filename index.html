<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lampa Plugins – SimSomNat</title>
<style>
  :root{--bg:#0b1220;--card:#111a2a;--border:#1c2a44;--text:#e7eefc;--muted:#a8b4ce}
  *{box-sizing:border-box}
  body{font:16px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:920px;margin:40px auto;padding:0 16px;background:var(--bg);color:var(--text)}
  h1{font-size:28px;margin:0 0 8px}
  ul{list-style:none;padding:0;margin:20px 0}
  li.item{display:flex;align-items:center;justify-content:space-between;gap:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:12px 0}
  .left{min-width:0}
  .left strong{display:block;font-size:18px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .left small{color:var(--muted)}
  .right{flex:0 0 auto;display:flex;gap:8px}
  .btn{appearance:none;border:1px solid var(--border);background:#16233a;color:#cfe0ff;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;font-size:14px}
  .btn:hover{border-color:#2a3d66}
  .btn.copy:disabled{opacity:.6;cursor:default}
  @media (max-width:580px){ li.item{flex-direction:column;align-items:stretch} .right{justify-content:flex-start} }
</style>

<h1>Lampa Plugins</h1>
<ul id="list"><li class="item"><div class="left"><strong>Загружаю список…</strong><small>Загружаю описание...</small></div></li></ul>

<script>
const user='SimSomNat', repo='lampa-plg', branch='main';
const pagesBase=`https://${user.toLowerCase()}.github.io/${repo}/`;

/* Читает описание из начала .js:
   Поддерживает:
   1) строку: // @lampa-desc: текст
   2) блок:   /* @lampa { "desc":"текст" } *\/
*/
async function getDesc(relPath){
  const targets = [
    `${pagesBase}${relPath}`,                                           // GitHub Pages
    `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${relPath}` // raw fallback
  ];
  for (const url of targets){
    try{
      const res = await fetch(url + '?_=' + Date.now()); // анти-кэш
      if (!res.ok) continue;
      const txt = await res.text();

      const mb = txt.match(/\/\*\s*@lampa([\s\S]*?)\*\//i);
      if (mb){
        try{
          const j = JSON.parse(mb[1]);
          if (j && j.desc) return String(j.desc).trim();
        }catch(e){}
      }

      const ml = txt.match(/^[ \t]*\/\/[ \t]*@lampa[-_ ]?desc[ \t]*:[ \t]*(.+)$/im);
      if (ml) return ml[1].replace(/\r$/, '').trim();
    }catch(e){}
  }
  return '';
}

async function walk(path=''){
  const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${branch}`);
  const items = await res.json();
  if (!Array.isArray(items)) throw new Error('GitHub API error/limit');

  // очищаем заглушку «Загружаю…»
  const listEl = document.getElementById('list');
  if (listEl.children.length) listEl.innerHTML = '';

  let count = 0;
  for (const it of items){
    if (it.type === 'file' && it.name.endsWith('.js')){ await add(it.path); count++; }
    if (it.type === 'dir') await walk(it.path);
  }
  if (!count){
    // fallback, если нет файлов/лимит GitHub API
    await add('LocalBackup.js');
  }
}

async function add(relPath){
  const url  = pagesBase + relPath; // чистый URL без ?v
  const desc = (await getDesc(relPath)) || 'Ссылки на плагин для Lampa';

  const li = document.createElement('li');
  li.className = 'item';
  li.innerHTML = `
    <div class="left">
      <strong>${relPath}</strong>
      <small>${desc}</small>
    </div>
    <div class="right">
      <a class="btn" href="${url}" target="_blank" rel="noopener">Открыть плагин</a>
      <button class="btn copy" data-url="${url}" aria-label="Скопировать ссылку">Скопировать ссылку</button>
    </div>`;
  document.getElementById('list').appendChild(li);
}

document.getElementById('list').addEventListener('click', async (e)=>{
  const btn = e.target.closest('.copy');
  if (!btn) return;
  const link = btn.dataset.url;
  try{
    await navigator.clipboard.writeText(link);
    const old = btn.textContent;
    btn.textContent = 'Скопировано!';
    btn.disabled = true;
    setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1400);
  }catch{
    prompt('Скопируйте ссылку:', link);
  }
});

walk();
</script>
</html>
